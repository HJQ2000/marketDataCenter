<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>
<h1>WebSocket & Chart</h1>
<form id="stockForm">
  <input type="text" id="stockCodeInput" placeholder="Enter Stock Symbol">
  <button type="submit">Submit</button>
</form>
<div id="output">
  <p>Message Here:</p>
</div>

<canvas id="stockChart" width="800" height="400"></canvas>

</body>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script>

  let stockData = [];
  let label = generateTimeLabels();
  function generateTimeLabels() {
    const labels = [];
    const morningStartTime = new Date("2023-01-01T09:30:00");
    const morningEndTime = new Date("2023-01-01T11:30:00");
    const afternoonStartTime = new Date("2023-01-01T13:00:00");
    const afternoonEndTime = new Date("2023-01-01T15:00:00");

    let currentTime = new Date(morningStartTime);

    while (currentTime <= morningEndTime) {
      labels.push(currentTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }));
      currentTime.setMinutes(currentTime.getMinutes() + 1);
    }

    currentTime = new Date(afternoonStartTime);

    while (currentTime <= afternoonEndTime) {
      labels.push(currentTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }));
      currentTime.setMinutes(currentTime.getMinutes() + 1);
    }

    return labels;
  }

  const ctx = document.getElementById('stockChart').getContext('2d');
  const config = {
    type: 'line',
    data: {
      labels: label,
      datasets: [{
        label: 'Stock Price',
        borderColor: 'blue',
        borderWidth: 2,
        data: stockData,
        fill: false,
      }],
    },
    options: {
      responsive: false,
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false
        },
        title: {
          display: true,
          text: '股票分时图'
        }
      },
      hover: {
        mode: 'index',
        intersect: false
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Time'
          },
          grid: {
            display: false,
          },
          ticks:{
            autoSkip: false,
            callback: function(val, index) {
              return index % 30 === 0 ? this.getLabelForValue(val) : '';
            },

          },
        },
        y: {
          title: {
            display: true,
            text: 'Price'
          },
          suggestedMin: 1740,
          suggestedMax: 1800,
          ticks: {
            // forces step size to be 50 units
            stepSize: 2
          }
        }
      },
      elements: {
        point: {
          radius: 1, // 设置数据点的大小
        },
      },
    },
  };

  const stockChart = new Chart(ctx, config);

  let stompClient = null;
  const socket = new SockJS('/websocket');
  stompClient = Stomp.over(socket);
  stompClient.connect({}, function (frame) {
    console.log('Connected: ' + frame);

    // 提交表单时获取输入的股票号
    document.getElementById('stockForm').addEventListener('submit', function (event) {
      event.preventDefault();
      const stockCodeInput = document.getElementById('stockCodeInput').value;

      // 发送股票号到后端
      stompClient.send('/app/stock', {}, stockCodeInput);
    });

    // 订阅股票数据
    stompClient.subscribe('/topic/stockData', function (message) {
      const data = JSON.parse(message.body);
      // 在这里处理从后端获取的股票数据
      // labels = stockData.map(data => data.timeStampChina.slice(11, -3));
      stockData = data.map(data => data.curPrice);
      stockChart.data.datasets[0].data = stockData;
      stockChart.update();
    });

    stompClient.subscribe('/topic/stockData/sh600519', function (message) {
      const newdata = JSON.parse(message.body);
      console.log(newdata);
      document.getElementById("output").innerHTML += newdata.curPrice;
      stockData.push(newdata.curPrice)
      stockChart.data.datasets[0].data = stockData;
      stockChart.update();
    });


  });


</script>
</html>