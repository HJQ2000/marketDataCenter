<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>
<h1>WebSocket & Chart</h1>
<form id="stockForm">
  <input type="text" id="stockCodeInput" placeholder="Enter Stock Symbol">
  <button type="submit">Submit</button>
</form>
<div id="output">
  <p>Message Here:</p>
</div>

<canvas id="stockChart" width="800" height="400"></canvas>

</body>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

  let stompClient = null;
  let stockData;
  const socket = new SockJS('/websocket');
  stompClient = Stomp.over(socket);
  stompClient.connect({}, function (frame) {
    console.log('Connected: ' + frame);

    // 提交表单时获取输入的股票号
    document.getElementById('stockForm').addEventListener('submit', function (event) {
      event.preventDefault();
      const stockCodeInput = document.getElementById('stockCodeInput').value;

      // 发送股票号到后端
      stompClient.send('/app/stock', {}, stockCodeInput);
    });

    // 订阅股票数据
    stompClient.subscribe('/topic/stockData', function (message) {
      stockData = JSON.parse(message.body);
      // 在这里处理从后端获取的股票数据

      const ctx = document.getElementById('stockChart').getContext('2d');
      const stockChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: stockData.map(data => data.timeStampChina.slice(11, -3)),
          datasets: [{
            label: 'Stock Price',
            borderColor: 'blue',
            borderWidth: 2,
            data: stockData.map(data => data.curPrice),
            fill: false,
          }],
        },
        options: {
          responsive: false,
          aspectRatio: 1,
          plugins:{
            tooltip: {
              intersect: false,
              mode: 'index',
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.parsed.y;
                  return label;
                },
              },
            },
          },
          elements: {
            point: {
              radius: 2, // 设置数据点的大小
            },
          },
          // scales: {
          //   x: {
          //     type: 'linear',
          //     ticks: {
          //       min: '09:30',
          //       max: '15:00',
          //     },
          //   },
          //   y: {
          //     ticks: {
          //       beginAtZero: false,
          //     },
          //   },
          // },
        },
      });

    });

    stompClient.subscribe('/topic/stockData/sh600519', function (message) {
      const data = JSON.parse(message.body);
      console.log(data);
      document.getElementById("output").innerHTML += data.curPrice;
    });

  });


</script>
</html>